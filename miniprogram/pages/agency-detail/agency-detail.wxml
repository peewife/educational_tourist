<!--pages/agency-detail/agency-detail.wxml-->
<view class="page-container">
  <!-- 顶部固定区域：标题 -->
  <view class="header" style="padding-top: {{statusBarHeight}}px;">
    <view class="header-content">
      <view class="back-button" bindtap="onBackTap">
        <t-icon name="chevron-left" size="52rpx" color="#1a1a1a" />
      </view>
      <!-- 标题栏 -->
      <view class="title-bar">
        <text class="app-title">机构详情</text>
      </view>
    </view>
  </view>

  <view style="height: calc({{statusBarHeight}}px + 108rpx);"></view> <!-- Placeholder for fixed header -->

  <block wx:if="{{agency}}">
    <!-- 封面区域 (Logo展示) -->
    <view class="cover-section">
      <view class="logo-box">
        <text class="logo-char">{{agency.logoText}}</text>
      </view>
    </view>

    <!-- 基本信息 -->
    <view class="info-section">
      <text class="agency-title">{{agency.name}}</text>
      <view class="info-list">
        <view class="info-item">
          <text class="info-label">机构类型:</text>
          <text class="info-value">{{agency.type}}</text>
        </view>
      </view>
    </view>

    <!-- 地址与导航卡片 -->
    <view class="location-card" bindtap="onNavigateTap">
      <view class="location-info">
        <view class="location-icon-box">
          <t-icon name="location" size="40rpx" color="var(--td-brand-color)" />
        </view>
        <view class="location-detail">
          <text class="location-title">地址信息</text>
          <text class="location-address">{{agency.address}}</text>
        </view>
      </view>
      <view class="location-actions">
         <t-icon name="navigation" size="40rpx" color="#999" />
         <t-icon name="call" size="40rpx" color="#999" catchtap="onPhoneTap" />
      </view>
    </view>

    <!-- 分隔条 -->
    <view class="divider" />

    <!-- Tab切换 -->
    <view class="tab-bar" style="top: calc({{statusBarHeight}}px + 108rpx);">
      <view 
        wx:for="{{tabs}}" 
        wx:key="id"
        class="tab-item {{currentTab === item.id ? 'active' : ''}}"
        data-id="{{item.id}}"
        bindtap="onTabChange"
      >
        <text class="tab-text">{{item.name}}</text>
        <view wx:if="{{currentTab === item.id}}" class="tab-indicator" />
      </view>
    </view>

    <!-- Tab内容区域 -->
    <view class="tab-content">
      <!-- 机构详情 -->
      <view wx:if="{{currentTab === 'detail'}}" class="detail-content">
        <expandable-text 
          content="{{agency.description}}" 
          maxLines="{{6}}"
        />
      </view>

      <!-- 相关线路 -->
      <view wx:if="{{currentTab === 'routes'}}" class="routes-content">
        <view wx:if="{{relatedRoutes.length > 0}}" class="route-list">
          <view 
            wx:for="{{relatedRoutes}}" 
            wx:key="id"
            class="route-item"
            bindtap="onRouteTap"
            data-id="{{item.id}}"
          >
            <view class="route-cover">
              <image class="route-image" src="{{item.imageUrl}}" mode="aspectFill" />
            </view>
            <view class="route-info">
              <text class="route-title">{{item.title}}</text>
              <view class="route-tags">
                <text 
                  wx:for="{{item.gradeLevel}}" 
                  wx:for-item="grade"
                  wx:key="*this"
                  class="tag"
                >{{grade}}</text>
              </view>
            </view>
          </view>
        </view>
        <view wx:else class="empty-tip">暂无相关线路</view>
      </view>

      <!-- 研学导师 -->
      <view wx:if="{{currentTab === 'experts'}}" class="experts-content">
        <view wx:if="{{relatedExperts.length > 0}}" class="expert-grid">
          <view 
            wx:for="{{relatedExperts}}" 
            wx:key="id"
            class="expert-item"
            bindtap="onExpertTap"
            data-id="{{item.id}}"
          >
            <view class="expert-avatar">
              <image class="avatar-image" src="{{item.avatarUrl}}" mode="aspectFill" />
            </view>
            <text class="expert-name">{{item.name}}</text>
          </view>
        </view>
        <view wx:else class="empty-tip">暂无研学导师</view>
      </view>
    </view>

    <view class="safe-bottom" />
  </block>
</view>
